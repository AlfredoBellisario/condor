language: python

python:
  - "2.7"

#sudo: false
#sudo: true

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/libspimage
    - $HOME/spsim
    - $HOME/local
    - $HOME/build/mhantke/condor/hdf5-1.8.17/hdf5

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - kubuntu-backports
      - couchbase-precise
    packages:
      - libpng-dev
      - libtiff4-dev
      - libfftw3-dev
      - cmake
      - gsl-bin
      - libgsl0-dev

before_install:
  - echo $HOME
# Install hdf5
  - HDF5DIR="$HOME/build/mhantke/condor/hdf5-1.8.17/hdf5"
  - if [ ! -d "$HDF5DIR" ]; then wget http://www.hdfgroup.org/ftp/HDF5/current/src/hdf5-1.8.17.tar.gz && tar xvzf hdf5-1.8.17.tar.gz; cd hdf5-1.8.17 && ./configure && make && sudo make install; else echo 'Using hdf5 from cached directory'; fi
#  - cat /usr/include/H5public.h
#  - cat /usr/include/H5version.h
#  - dpkg -l | grep hdf5
# Install libspimage
  - cd $HOME
  - if [ ! -d "$HOME/libspimage/.git" ]; then git clone https://github.com/FilipeMaia/libspimage; else echo 'Using libspimage from cached directory'; fi
  - mkdir -p libspimage/build && cd libspimage/build
  - git pull
  - cmake -DCMAKE_VERBOSE_MAKEFILE=ON -DUSE_CUDA=OFF -DCMAKE_C_FLAGS="-DH5_USE_18_API" -DHDF5_INCLUDE_DIR=$HOME/build/mhantke/condor/hdf5-1.8.17/hdf5/include -DHDF5_LIBRARY=$HOME/build/mhantke/condor/hdf5-1.8.17/hdf5/lib/libhdf5.so -DCMAKE_INSTALL_PREFIX=${HOME}/local ..
  - make -j 2
  - make install
  - export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${HOME}/local/lib
# Install spsim
  - cd $HOME
  - if [ ! -d "$HOME/spsim/.git" ]; then git clone https://github.com/FilipeMaia/spsim; else echo 'Using spsim from cached directory'; fi
  - mkdir -p spsim/build && cd spsim/build
  - git pull
  - cmake -DUSE_CUDA=OFF -DUSE_NFFT=OFF -DCMAKE_INSTALL_PREFIX=${HOME}/local ..
  - make -j 2
  - make install
  - export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${HOME}/local/lib
# szip???
# command to install dependencies
#install: "pip install -r requirements.txt"
# command to run tests
script: python -m unittest -v condor.tests.test_all
